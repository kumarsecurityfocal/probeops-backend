<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProbeOps Dashboard</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        body {
            min-height: 100vh;
            background-color: #191c20;
        }
        .navbar-brand {
            font-weight: bold;
            color: #5d87ff !important;
        }
        .nav-link.active {
            background-color: rgba(93, 135, 255, 0.1) !important;
            color: #5d87ff !important;
            border-radius: 0.25rem;
        }
        .container {
            max-width: 1200px;
            padding: 2rem;
        }
        .card {
            background-color: #212529;
            border: none;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: rgba(33, 37, 41, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
        }
        pre.result {
            background-color: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: 0.25rem;
            min-height: 150px;
            max-height: 350px;
            overflow: auto;
        }
        .probe-history {
            background-color: #212529;
            border-radius: 0.5rem;
        }
        .loader {
            border: 4px solid rgba(93, 135, 255, 0.3);
            border-top: 4px solid #5d87ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body data-bs-theme="dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ProbeOps</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/docs">API Docs</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdownToggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            User
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownToggle">
                            <li><a class="dropdown-item" href="#" id="viewProfileLink">View Profile</a></li>
                            <li><a class="dropdown-item" href="#" id="manageApiKeysLink">Manage API Keys</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutLink">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="loginSection" class="auth-form">
            <div class="card">
                <div class="card-header">Login to ProbeOps</div>
                <div class="card-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                    </form>
                    <div class="mt-3 text-center">
                        <p>Don't have an account? <a href="#" id="showRegisterLink">Register</a></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="registerSection" class="auth-form" style="display: none;">
            <div class="card">
                <div class="card-header">Register for ProbeOps</div>
                <div class="card-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Register</button>
                        </div>
                    </form>
                    <div class="mt-3 text-center">
                        <p>Already have an account? <a href="#" id="showLoginLink">Login</a></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" style="display: none;">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">Network Probes</div>
                        <div class="card-body">
                            <ul class="nav nav-pills mb-3" id="probesTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="ping-tab" data-bs-toggle="pill" data-bs-target="#ping" type="button" role="tab" aria-controls="ping" aria-selected="true">Ping</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="traceroute-tab" data-bs-toggle="pill" data-bs-target="#traceroute" type="button" role="tab" aria-controls="traceroute" aria-selected="false">Traceroute</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dns-tab" data-bs-toggle="pill" data-bs-target="#dns" type="button" role="tab" aria-controls="dns" aria-selected="false">DNS Lookup</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="whois-tab" data-bs-toggle="pill" data-bs-target="#whois" type="button" role="tab" aria-controls="whois" aria-selected="false">WHOIS</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="probesTabsContent">
                                <div class="tab-pane fade show active" id="ping" role="tabpanel" aria-labelledby="ping-tab">
                                    <form id="pingForm" class="probe-form">
                                        <div class="mb-3">
                                            <label for="pingHost" class="form-label">Host or IP Address</label>
                                            <input type="text" class="form-control" id="pingHost" name="host" placeholder="example.com" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pingCount" class="form-label">Ping Count</label>
                                            <select class="form-select" id="pingCount" name="count">
                                                <option value="4">4 packets</option>
                                                <option value="8">8 packets</option>
                                                <option value="16">16 packets</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Run Ping</button>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="traceroute" role="tabpanel" aria-labelledby="traceroute-tab">
                                    <form id="tracerouteForm" class="probe-form">
                                        <div class="mb-3">
                                            <label for="tracerouteHost" class="form-label">Host or IP Address</label>
                                            <input type="text" class="form-control" id="tracerouteHost" name="host" placeholder="example.com" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="tracerouteMaxHops" class="form-label">Maximum Hops</label>
                                            <select class="form-select" id="tracerouteMaxHops" name="max_hops">
                                                <option value="15">15 hops</option>
                                                <option value="20">20 hops</option>
                                                <option value="30">30 hops</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Run Traceroute</button>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="dns" role="tabpanel" aria-labelledby="dns-tab">
                                    <form id="dnsForm" class="probe-form">
                                        <div class="mb-3">
                                            <label for="dnsDomain" class="form-label">Domain Name</label>
                                            <input type="text" class="form-control" id="dnsDomain" name="domain" placeholder="example.com" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="dnsRecordType" class="form-label">Record Type</label>
                                            <select class="form-select" id="dnsRecordType" name="record_type">
                                                <option value="A">A (IPv4 Address)</option>
                                                <option value="AAAA">AAAA (IPv6 Address)</option>
                                                <option value="MX">MX (Mail Exchange)</option>
                                                <option value="NS">NS (Name Server)</option>
                                                <option value="TXT">TXT (Text Record)</option>
                                                <option value="CNAME">CNAME (Canonical Name)</option>
                                                <option value="SOA">SOA (Start of Authority)</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Run DNS Lookup</button>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="whois" role="tabpanel" aria-labelledby="whois-tab">
                                    <form id="whoisForm" class="probe-form">
                                        <div class="mb-3">
                                            <label for="whoisDomain" class="form-label">Domain Name</label>
                                            <input type="text" class="form-control" id="whoisDomain" name="domain" placeholder="example.com" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Run WHOIS Lookup</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span>Probe Results</span>
                            <div class="float-end">
                                <button id="saveResultBtn" class="btn btn-sm btn-outline-secondary" disabled>Save Result</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="probeResultLoader" class="loader hidden"></div>
                            <pre id="probeResult" class="result">Run a probe to see results here.</pre>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <span>Probe History</span>
                            <div class="float-end">
                                <button id="refreshHistoryBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="historyList" class="list-group">
                                <div class="text-center text-muted">No history yet</div>
                            </div>
                            <div id="historyPagination" class="d-flex justify-content-between mt-3 hidden">
                                <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary">&laquo; Previous</button>
                                <span id="paginationInfo" class="align-self-center">Page 1 of 1</span>
                                <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary">Next &raquo;</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span>Account Information</span>
                        </div>
                        <div class="card-body">
                            <div id="accountInfo">
                                <div class="text-center text-muted">Login to view account details</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Base API URL
        const API_BASE_URL = '/api';
        
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const userDropdown = document.getElementById('userDropdown');
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const accountInfo = document.getElementById('accountInfo');
        const probeResult = document.getElementById('probeResult');
        const probeResultLoader = document.getElementById('probeResultLoader');
        const saveResultBtn = document.getElementById('saveResultBtn');
        const historyList = document.getElementById('historyList');
        const historyPagination = document.getElementById('historyPagination');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        
        // State variables
        let jwtToken = localStorage.getItem('probeops_token');
        let currentUser = null;
        let historyPage = 1;
        let historyTotalPages = 1;
        let currentProbeType = '';
        let currentProbeTarget = '';
        let currentProbeResult = '';
        
        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (jwtToken) {
                fetchUserInfo()
                    .then(() => {
                        if (currentUser) {
                            showDashboard();
                            loadProbeHistory();
                        } else {
                            // Token invalid, show login
                            showLogin();
                        }
                    })
                    .catch(err => {
                        console.error('Error loading user info:', err);
                        showLogin();
                    });
            } else {
                showLogin();
            }
            
            // Show/hide auth forms
            document.getElementById('showRegisterLink').addEventListener('click', function(e) {
                e.preventDefault();
                loginSection.style.display = 'none';
                registerSection.style.display = 'block';
            });
            
            document.getElementById('showLoginLink').addEventListener('click', function(e) {
                e.preventDefault();
                registerSection.style.display = 'none';
                loginSection.style.display = 'block';
            });
            
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('pingForm').addEventListener('submit', handleProbe);
            document.getElementById('tracerouteForm').addEventListener('submit', handleProbe);
            document.getElementById('dnsForm').addEventListener('submit', handleProbe);
            document.getElementById('whoisForm').addEventListener('submit', handleProbe);
            
            // Other event listeners
            document.getElementById('logoutLink').addEventListener('click', handleLogout);
            document.getElementById('refreshHistoryBtn').addEventListener('click', loadProbeHistory);
            document.getElementById('saveResultBtn').addEventListener('click', saveProbeResult);
            prevPageBtn.addEventListener('click', () => {
                if (historyPage > 1) {
                    historyPage--;
                    loadProbeHistory();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (historyPage < historyTotalPages) {
                    historyPage++;
                    loadProbeHistory();
                }
            });
        });
        
        // Auth functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                probeResultLoader.classList.remove('hidden');
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                probeResultLoader.classList.add('hidden');
                
                if (response.ok) {
                    jwtToken = data.token;
                    localStorage.setItem('probeops_token', jwtToken);
                    await fetchUserInfo();
                    showDashboard();
                    loadProbeHistory();
                } else {
                    alert(`Login failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                probeResultLoader.classList.add('hidden');
                console.error('Login error:', error);
                alert('Login failed: Network error');
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                probeResultLoader.classList.remove('hidden');
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                probeResultLoader.classList.add('hidden');
                
                if (response.ok) {
                    alert('Registration successful! Please login.');
                    document.getElementById('registerForm').reset();
                    showLogin();
                } else {
                    alert(`Registration failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                probeResultLoader.classList.add('hidden');
                console.error('Registration error:', error);
                alert('Registration failed: Network error');
            }
        }
        
        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem('probeops_token');
            jwtToken = null;
            currentUser = null;
            showLogin();
        }
        
        // Fetch user info from API
        async function fetchUserInfo() {
            if (!jwtToken) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    updateUserInfo();
                } else {
                    localStorage.removeItem('probeops_token');
                    jwtToken = null;
                    currentUser = null;
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                localStorage.removeItem('probeops_token');
                jwtToken = null;
                currentUser = null;
            }
        }
        
        // Update UI with user info
        function updateUserInfo() {
            if (!currentUser) return;
            
            userDropdownToggle.textContent = currentUser.username;
            userDropdown.style.display = 'block';
            
            // Update account info card
            let userInfoHtml = `
                <dl class="row mb-0">
                    <dt class="col-sm-4">Username:</dt>
                    <dd class="col-sm-8">${currentUser.username}</dd>
                    
                    <dt class="col-sm-4">Email:</dt>
                    <dd class="col-sm-8">${currentUser.email}</dd>
                    
                    <dt class="col-sm-4">Role:</dt>
                    <dd class="col-sm-8">${currentUser.role}</dd>
                    
                    <dt class="col-sm-4">Subscription:</dt>
                    <dd class="col-sm-8">${currentUser.subscription_tier}</dd>
                </dl>
            `;
            accountInfo.innerHTML = userInfoHtml;
        }
        
        // Handle probe requests
        async function handleProbe(e) {
            e.preventDefault();
            
            if (!jwtToken) {
                alert('Please login to use this feature');
                return;
            }
            
            const formId = e.target.id;
            let endpoint, formData;
            
            // Get form data and endpoint
            if (formId === 'pingForm') {
                endpoint = `${API_BASE_URL}/probes/ping`;
                const host = document.getElementById('pingHost').value;
                const count = document.getElementById('pingCount').value;
                formData = { host, count: parseInt(count) };
                currentProbeType = 'ping';
                currentProbeTarget = host;
            } else if (formId === 'tracerouteForm') {
                endpoint = `${API_BASE_URL}/probes/traceroute`;
                const host = document.getElementById('tracerouteHost').value;
                const maxHops = document.getElementById('tracerouteMaxHops').value;
                formData = { host, max_hops: parseInt(maxHops) };
                currentProbeType = 'traceroute';
                currentProbeTarget = host;
            } else if (formId === 'dnsForm') {
                endpoint = `${API_BASE_URL}/probes/dns`;
                const domain = document.getElementById('dnsDomain').value;
                const recordType = document.getElementById('dnsRecordType').value;
                formData = { domain, record_type: recordType };
                currentProbeType = 'dns';
                currentProbeTarget = domain;
            } else if (formId === 'whoisForm') {
                endpoint = `${API_BASE_URL}/probes/whois`;
                const domain = document.getElementById('whoisDomain').value;
                formData = { domain };
                currentProbeType = 'whois';
                currentProbeTarget = domain;
            }
            
            if (!endpoint || !formData) return;
            
            // Show loader and clear previous results
            probeResultLoader.classList.remove('hidden');
            probeResult.textContent = 'Running probe...';
            saveResultBtn.disabled = true;
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                // Hide loader
                probeResultLoader.classList.add('hidden');
                
                if (response.ok) {
                    // Format result
                    currentProbeResult = data.result;
                    probeResult.textContent = data.result;
                    saveResultBtn.disabled = false;
                    
                    // Refresh history
                    loadProbeHistory();
                } else {
                    probeResult.textContent = `Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                probeResultLoader.classList.add('hidden');
                console.error('Probe error:', error);
                probeResult.textContent = 'Error: Network or server error occurred';
            }
        }
        
        // Load probe history
        async function loadProbeHistory() {
            if (!jwtToken) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/probes/history?page=${historyPage}&limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update pagination
                    historyTotalPages = data.pagination.total_pages || 1;
                    paginationInfo.textContent = `Page ${historyPage} of ${historyTotalPages}`;
                    
                    // Show/hide pagination
                    if (historyTotalPages > 1) {
                        historyPagination.classList.remove('hidden');
                    } else {
                        historyPagination.classList.add('hidden');
                    }
                    
                    // Enable/disable pagination buttons
                    prevPageBtn.disabled = historyPage <= 1;
                    nextPageBtn.disabled = historyPage >= historyTotalPages;
                    
                    // Display history
                    if (data.items && data.items.length > 0) {
                        let historyHtml = '';
                        data.items.forEach(item => {
                            const date = new Date(item.created_at).toLocaleString();
                            const success = item.success ? 'success' : 'danger';
                            historyHtml += `
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                                   data-probe-id="${item.id}" data-result="${escape(item.result)}">
                                    <div>
                                        <div class="fw-bold">${item.probe_type}: ${item.target}</div>
                                        <small class="text-muted">${date}</small>
                                    </div>
                                    <span class="badge text-bg-${success}">${item.success ? 'Success' : 'Failed'}</span>
                                </a>
                            `;
                        });
                        historyList.innerHTML = historyHtml;
                        
                        // Add event listeners to history items
                        document.querySelectorAll('#historyList a').forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                probeResult.textContent = unescape(this.dataset.result);
                                saveResultBtn.disabled = true;
                            });
                        });
                    } else {
                        historyList.innerHTML = '<div class="text-center text-muted">No history yet</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
        
        // Save probe result
        function saveProbeResult() {
            if (!currentProbeResult) return;
            
            const filename = `${currentProbeType}_${currentProbeTarget}_${new Date().toISOString().replace(/:/g, '-')}.txt`;
            const blob = new Blob([currentProbeResult], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // UI state functions
        function showLogin() {
            loginSection.style.display = 'block';
            registerSection.style.display = 'none';
            dashboardSection.style.display = 'none';
            userDropdown.style.display = 'none';
            document.getElementById('email').focus();
        }
        
        function showDashboard() {
            loginSection.style.display = 'none';
            registerSection.style.display = 'none';
            dashboardSection.style.display = 'block';
        }
    </script>
</body>
</html>